# 项目建表语句、初始化数据脚本及整体设计文档

## 一、项目概述

本项目是一个基于Flask框架的按摩理疗预约平台，提供用户注册、登录、查看理疗师信息、预约服务、管理订单和提交评价等功能。系统采用RESTful API架构，支持前端与后端分离开发。

## 二、建表语句（ORM模型定义）

项目使用SQLAlchemy ORM框架，通过模型类自动生成建表语句。主要表结构如下：

### 1. 用户相关表

#### users表：存储用户基本信息
```python
from sqlalchemy import Column, Integer, String, DateTime, Text
from sqlalchemy.orm import relationship
import datetime
from app import db

class User(db.Model):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    username = Column(String(50), nullable=False)
    phone = Column(String(20), unique=True, nullable=False)
    email = Column(String(100))
    password_hash = Column(String(100))  # 密码哈希
    avatar = Column(String(255))
    status = Column(Integer, default=1)  # 1:正常, 0:禁用
    role = Column(String(20), default='user')  # user:普通用户, therapist:治疗师, admin:管理员
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)

    # 关系
    orders = relationship("Order", back_populates="user")
    addresses = relationship("UserAddress", back_populates="user")
    feedbacks = relationship("Feedback", back_populates="user")
```

#### user_addresses表：存储用户地址信息
```python
class UserAddress(db.Model):
    __tablename__ = 'user_addresses'

    id = Column(Integer, primary_key=True)
    user_id = Column(Integer, db.ForeignKey('users.id'))
    name = Column(String(50))  # 地址名称
    address = Column(Text, nullable=False)  # 详细地址
    latitude = Column(String(20))  # 纬度
    longitude = Column(String(20))  # 经度
    is_default = Column(Integer, default=0)  # 是否默认地址
    created_at = Column(DateTime, default=datetime.datetime.utcnow)

    user = relationship("User", back_populates="addresses")
```

### 2. 理疗师相关表

#### therapists表：存储理疗师信息
```python
from sqlalchemy import Column, Integer, String, DateTime, Text, Float
from sqlalchemy.orm import relationship
import datetime
from app import db

class Therapist(db.Model):
    __tablename__ = 'therapists'

    id = Column(Integer, primary_key=True)
    name = Column(String(50), nullable=False)
    phone = Column(String(20), unique=True, nullable=False)
    id_card = Column(String(20))  # 身份证号
    age = Column(Integer)  # 年龄
    certification = Column(String(255))  # 资格证书
    experience_years = Column(Integer)  # 经验年限
    specialty = Column(String(255))  # 专长
    rating = Column(Float, default=5.0)  # 评分
    service_count = Column(Integer, default=0)  # 服务次数
    status = Column(Integer, default=0)  # 0:待审核, 1:正常, 2:暂停
    avatar = Column(String(255))  # 头像
    introduction = Column(Text)  # 简介
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)

    # 关联服务项目
    service_items = relationship("ServiceItem", secondary="therapist_services")
    orders = relationship("Order", back_populates="therapist")
    feedbacks = relationship("Feedback", back_populates="therapist")
```

#### service_items表：存储服务项目信息
```python
class ServiceItem(db.Model):
    __tablename__ = 'service_items'

    id = Column(Integer, primary_key=True)
    name = Column(String(100), nullable=False)
    description = Column(Text)
    duration = Column(Integer)  # 时长(分钟)
    price = Column(Float, nullable=False)  # 价格
    category = Column(String(50))  # 分类: classic, special, custom
    status = Column(Integer, default=1)  # 1:启用, 0:禁用
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
```

#### therapist_services表：理疗师与服务项目的多对多关联表
```python
therapist_services = db.Table('therapist_services',
                              Column('therapist_id', Integer, db.ForeignKey('therapists.id')),
                              Column('service_item_id', Integer, db.ForeignKey('service_items.id'))
                              )
```

### 3. 服务相关表

#### service表：存储服务信息
```python
from app import db
from datetime import datetime

class Service(db.Model):
    """服务项目模型"""
    __tablename__ = 'service'
    
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    name = db.Column(db.String(100), nullable=False, comment='服务名称')
    description = db.Column(db.Text, nullable=False, comment='服务描述')
    price = db.Column(db.Numeric(10, 2), nullable=False, comment='服务价格')
    duration = db.Column(db.Integer, nullable=False, comment='服务时长(分钟)')
    category = db.Column(db.String(50), nullable=False, comment='服务分类')
    is_active = db.Column(db.Boolean, default=True, nullable=False, comment='是否启用')
    created_at = db.Column(db.DateTime, default=datetime.now, nullable=False, comment='创建时间')
    updated_at = db.Column(db.DateTime, default=datetime.now, onupdate=datetime.now, nullable=False, comment='更新时间')
    
    def to_dict(self):
        """转换为字典格式"""
        return {
            'id': self.id,
            'name': self.name,
            'description': self.description,
            'price': float(self.price),
            'duration': self.duration,
            'category': self.category,
            'is_active': self.is_active,
            'created_at': self.created_at.strftime('%Y-%m-%d %H:%M:%S'),
            'updated_at': self.updated_at.strftime('%Y-%m-%d %H:%M:%S')
        }
```

### 4. 订单相关表

#### orders表：存储订单信息
```python
from sqlalchemy import Column, Integer, String, DateTime, Text, Float, ForeignKey
from sqlalchemy.orm import relationship
import datetime
from app import db

class Order(db.Model):
    __tablename__ = 'orders'

    id = Column(Integer, primary_key=True)
    order_no = Column(String(50), unique=True, nullable=False)
    user_id = Column(Integer, ForeignKey('users.id'))
    therapist_id = Column(Integer, ForeignKey('therapists.id'))
    service_item_id = Column(Integer)  # 服务项目ID
    service_name = Column(String(100))  # 服务名称(快照)
    duration = Column(Integer)  # 时长(分钟)
    price = Column(Float)  # 价格
    service_time = Column(DateTime)  # 服务时间
    service_address = Column(Text)  # 服务地址
    contact_phone = Column(String(20))  # 联系电话
    status = Column(Integer, default=0)  # 0:待接单, 1:已接单, 2:技师出发, 3:服务中, 4:已完成, 5:已取消
    remark = Column(Text)  # 备注
    # 支付相关字段
    payment_status = Column(Integer, default=0)  # 0:未支付, 1:已支付, 2:支付失败, 3:已退款
    payment_method = Column(String(20))  # 支付方式: wechat, alipay, etc.
    transaction_id = Column(String(100))  # 支付平台交易ID
    paid_at = Column(DateTime)  # 支付时间
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)

    user = relationship("User", back_populates="orders")
    therapist = relationship("Therapist", back_populates="orders")
    feedback = relationship("Feedback", back_populates="order", uselist=False)
```

### 5. 评价相关表

#### feedbacks表：存储用户评价
```python
from sqlalchemy import Column, Integer, String, DateTime, Text, Float, ForeignKey
from sqlalchemy.orm import relationship
import datetime
from app import db

class Feedback(db.Model):
    __tablename__ = 'feedbacks'

    id = Column(Integer, primary_key=True)
    order_id = Column(Integer, ForeignKey('orders.id'), unique=True, nullable=False)  # 一个订单只能评价一次
    user_id = Column(Integer, ForeignKey('users.id'), nullable=False)
    therapist_id = Column(Integer, ForeignKey('therapists.id'), nullable=False)
    rating = Column(Float, nullable=False)  # 评分，1-5分
    content = Column(Text)  # 评价内容
    tags = Column(String(200))  # 评价标签，用逗号分隔
    created_at = Column(DateTime, default=datetime.datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.datetime.utcnow, onupdate=datetime.datetime.utcnow)

    # 关系
    user = relationship("User", back_populates="feedbacks")
    therapist = relationship("Therapist", back_populates="feedbacks")
    order = relationship("Order", back_populates="feedback")
```

## 三、初始化数据脚本

项目提供了多个初始化数据脚本，用于创建数据库和测试数据：

### 1. 建表脚本

**文件位置**：`d:/resources/flaskproject/lovaDate/create_tables.py`

```python
from main import create_app
from app import db

# 创建应用实例
app = create_app()

# 在应用上下文中创建数据库表
with app.app_context():
    print("正在创建数据库表...")
    db.create_all()
    print("数据库表创建完成！")
```

### 2. 服务数据初始化

**文件位置**：`d:/resources/flaskproject/lovaDate/init_default_services.py`

```python
from main import create_app
from app import db
from app.models.therapist import ServiceItem

app = create_app()
with app.app_context():
    # 检查是否已有服务项目
    existing_services = ServiceItem.query.count()
    
    if existing_services == 0:
        # 添加默认服务套餐
        default_services = [
            {
                'name': 'Classic Full Body Massage',
                'description': '90 minutes full body oil massage, relieve fatigue and relax body and mind',
                'duration': 90,
                'price': 198.0,
                'category': 'classic'
            },
            {
                'name': 'Premium SPA Package',
                'description': '120 minutes luxury SPA experience, including oil massage, hot stone therapy and facial care',
                'duration': 120,
                'price': 298.0,
                'category': 'special'
            },
            {
                'name': 'Local Deep Massage',
                'description': '60 minutes deep massage for shoulder/neck or waist, relieve muscle tension',
                'duration': 60,
                'price': 128.0,
                'category': 'classic'
            },
            {
                'name': 'Oil Back Massage Package',
                'description': '75 minutes back oil massage, promote blood circulation and relieve pressure',
                'duration': 75,
                'price': 168.0,
                'category': 'special'
            }
        ]
        
        # 插入默认服务项目
        for service_data in default_services:
            service = ServiceItem(**service_data)
            db.session.add(service)
        
        db.session.commit()
        print(f"成功添加 {len(default_services)} 个默认服务套餐")
    else:
        print(f"数据库中已有 {existing_services} 个服务项目，跳过初始化")
        
        # 显示现有服务项目
        existing = ServiceItem.query.all()
        for service in existing:
            print(f"- {service.name}: ￥{service.price} ({service.duration}分钟)")
```

### 3. 管理员用户创建

**文件位置**：`d:/resources/flaskproject/lovaDate/create_admin.py`

```python
from main import create_app
from app import db
from app.models.user import User
import hashlib

app = create_app()

with app.app_context():
    # 检查是否已存在管理员用户
    admin = User.query.filter_by(phone='13800138888').first()
    if admin:
        print('管理员用户已存在')
    else:
        # 创建管理员用户
        admin = User(
            username='admin',
            phone='13800138888',
            password_hash=hashlib.sha256('admin123'.encode()).hexdigest(),  # 使用SHA256加密密码
            role='admin',
            status=1
        )
        db.session.add(admin)
        db.session.commit()
        print('管理员用户创建成功')
```

### 4. 理疗师数据初始化

**文件位置**：`d:/resources/flaskproject/lovaDate/create_test_therapists.py`

```python
from main import create_app, db
from app.models.therapist import Therapist
from app.models.user import User

def create_test_therapists():
    app = create_app()
    with app.app_context():
        # 创建一些测试理疗师用户
        therapists = [
            {
                'name': '张医生',
                'phone': '13900139001',
                'id_card': '110101199001011234',
                'age': 35,
                'certification': '高级理疗师证书',
                'experience_years': 10,
                'specialty': '中医推拿',
                'rating': 4.8,
                'service_count': 120,
                'status': 1,
                'avatar': 'https://example.com/avatar1.jpg',
                'introduction': '10年中医推拿经验，擅长缓解颈椎、腰椎疼痛，使用传统中医手法结合现代理疗技术。'
            },
            {
                'name': '李按摩师',
                'phone': '13900139002',
                'id_card': '110101199202022345',
                'age': 32,
                'certification': '中级理疗师证书',
                'experience_years': 7,
                'specialty': '精油按摩',
                'rating': 4.6,
                'service_count': 95,
                'status': 1,
                'avatar': 'https://example.com/avatar2.jpg',
                'introduction': '专业精油按摩师，擅长全身精油SPA，帮助客户放松身心，改善睡眠质量。'
            },
            {
                'name': '王理疗师',
                'phone': '13900139003',
                'id_card': '110101199503033456',
                'age': 28,
                'certification': '初级理疗师证书',
                'experience_years': 3,
                'specialty': '拔罐刮痧',
                'rating': 4.5,
                'service_count': 60,
                'status': 1,
                'avatar': 'https://example.com/avatar3.jpg',
                'introduction': '擅长传统拔罐刮痧疗法，能够有效缓解身体疲劳和不适症状。'
            }
        ]
        
        created_count = 0
        for therapist_data in therapists:
            # 检查手机号是否已存在
            existing_user = User.query.filter_by(phone=therapist_data['phone']).first()
            if not existing_user:
                # 创建用户
                user = User(
                    username=therapist_data['name'],
                    phone=therapist_data['phone'],
                    password_hash='123456',
                    role='therapist'
                )
                db.session.add(user)
                db.session.flush()  # 获取用户ID
                
                # 创建理疗师信息
                therapist = Therapist(
                    id=user.id,  # 使用用户ID作为理疗师ID
                    name=therapist_data['name'],
                    phone=therapist_data['phone'],
                    id_card=therapist_data['id_card'],
                    age=therapist_data['age'],
                    certification=therapist_data['certification'],
                    experience_years=therapist_data['experience_years'],
                    specialty=therapist_data['specialty'],
                    rating=therapist_data['rating'],
                    service_count=therapist_data['service_count'],
                    status=therapist_data['status'],
                    avatar=therapist_data['avatar'],
                    introduction=therapist_data['introduction']
                )
                db.session.add(therapist)
                created_count += 1
            else:
                print(f'Therapist with phone {therapist_data["phone"]} already exists')
        
        db.session.commit()
        print(f'Successfully created {created_count} test therapists')

if __name__ == '__main__':
    create_test_therapists()
```

### 5. 测试订单创建

**文件位置**：`d:/resources/flaskproject/lovaDate/create_test_order.py`

```python
import os
import sys
from datetime import datetime, timedelta

# 添加项目根目录到Python路径
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from main import create_app, db
from app.models.user import User
from app.models.therapist import Therapist
from app.models.order import Order
from app.models.service import Service

# 创建应用
app = create_app()

with app.app_context():
    try:
        # 检查是否已有订单数据
        existing_orders = Order.query.count()
        if existing_orders > 0:
            print(f"数据库中已有 {existing_orders} 个订单，跳过创建测试数据")
            sys.exit(0)

        # 获取测试用户（假设已有用户）
        test_user = User.query.first()
        if not test_user:
            print("数据库中没有用户，无法创建订单")
            sys.exit(1)

        # 获取测试理疗师（假设已有理疗师）
        test_therapist = Therapist.query.first()
        if not test_therapist:
            print("数据库中没有理疗师，无法创建订单")
            sys.exit(1)

        # 获取测试服务（假设已有服务）
        test_service = Service.query.first()
        if not test_service:
            # 创建一个测试服务
            test_service = Service(
                name="全身按摩",
                description="60分钟全身放松按摩",
                duration=60,
                price=298,
                category="massage",
                is_active=True
            )
            db.session.add(test_service)
            db.session.commit()

        # 创建测试订单
        import uuid
        
        test_order = Order(
            order_no=f"ORD-{uuid.uuid4().hex[:12].upper()}",
            user_id=test_user.id,
            therapist_id=test_therapist.id,
            service_item_id=test_service.id,
            service_name=test_service.name,
            duration=test_service.duration,
            price=float(test_service.price),
            service_time=datetime.now() - timedelta(days=1),
            status=4,  # 已完成状态
            service_address="北京市朝阳区测试地址",
            contact_phone=test_user.phone,
            payment_status=1,  # 已支付
            payment_method="wechat",
            paid_at=datetime.now() - timedelta(days=1)
        )
        db.session.add(test_order)
        db.session.commit()

        print(f"成功创建测试订单: ID={test_order.id}, 订单号={test_order.order_no}")
        print("可使用此订单ID测试评价提交功能")

    except Exception as e:
        print(f"创建测试订单时出错: {e}")
        db.session.rollback()
        sys.exit(1)
    finally:
        db.session.close()
```

## 四、整体设计

### 1. 技术栈

- **后端框架**：Flask
- **数据库**：SQLAlchemy ORM（支持SQLite/MySQL）
- **认证**：JWT（JSON Web Token）
- **跨域**：Flask-CORS
- **数据库迁移**：Flask-Migrate
- **配置管理**：环境变量配置

### 2. 架构设计

项目采用分层架构设计，主要分为以下几个层次：

- **模型层（Models）**：定义数据结构和关系，位于`app/models/`
- **服务层（Services）**：实现业务逻辑，位于`app/services/`
- **API层（API）**：提供RESTful接口，位于`app/api/`，使用蓝图分组
- **工具层（Utils）**：提供通用功能，如认证、数据库连接

### 3. 配置管理

项目支持多环境配置（开发、测试、生产），通过`config.py`定义不同环境的配置参数：

- **开发环境**：使用SQLite数据库，允许所有跨域请求
- **测试环境**：使用MySQL数据库，启用SQL语句打印
- **生产环境**：使用MySQL数据库，配置严格的CORS和安全设置

### 4. API接口

主要API包括：

- **用户管理**：注册、登录、获取用户信息
- **理疗师管理**：获取理疗师列表、详情
- **服务管理**：获取服务列表、详情
- **订单管理**：创建订单、获取订单列表、订单状态更新
- **评价管理**：提交评价、获取评价列表

### 5. 前端测试

提供`static/index.html`页面用于API调试测试，包含用户注册、登录、创建订单、提交评价等功能测试

## 五、使用说明

### 1. 初始化步骤

建议按以下顺序执行初始化脚本：

1. 创建数据库表：`python create_tables.py`
2. 创建管理员用户：`python create_admin.py`
3. 初始化服务数据：`python init_default_services.py`
4. 创建测试理疗师：`python create_test_therapists.py`
5. 创建测试订单：`python create_test_order.py`

### 2. 运行项目

```bash
python main.py
```

项目将在`http://localhost:5000`启动，可通过`http://localhost:5000/static/index.html`访问前端测试页面

### 3. 管理员账户

- 手机号：13800138888
- 密码：admin123

### 4. 测试账户

- 理疗师1：手机号13900139001，密码123456
- 理疗师2：手机号13900139002，密码123456
- 理疗师3：手机号13900139003，密码123456

## 六、注意事项

1. **表结构重复**：`service`表和`service_items`表结构相似，可能存在设计冗余
2. **环境配置**：不同环境使用不同的数据库（开发使用SQLite，测试/生产使用MySQL）
3. **密码安全**：当前密码使用SHA256加密，建议在生产环境中使用更安全的加密方式
4. **生产环境**：在生产环境中应移除测试数据和调试功能
5. **API安全**：生产环境中应配置更严格的认证和授权机制

## 七、项目目录结构

```
d:/resources/flaskproject/lovaDate/
├── app/                  # 应用主目录
│   ├── __init__.py      # 应用初始化
│   ├── api/             # API接口
│   ├── models/          # 数据模型
│   ├── services/        # 业务逻辑
│   └── utils/           # 工具函数
├── static/              # 静态文件
├── migrations/          # 数据库迁移文件
├── create_tables.py     # 建表脚本
├── init_default_services.py  # 初始化服务数据
├── create_admin.py      # 创建管理员
├── create_test_therapists.py  # 创建测试理疗师
├── create_test_order.py # 创建测试订单
├── config.py            # 配置文件
└── main.py              # 主程序入口
```